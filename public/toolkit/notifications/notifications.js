!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("@spiral-toolkit/core")):"function"==typeof define&&define.amd?define("@spiral-toolkit/notifications",["@spiral-toolkit/core"],e):"object"==typeof exports?exports["@spiral-toolkit/notifications"]=e(require("@spiral-toolkit/core")):t.SFNotifications=e(t.SFToolkit)}(window,(function(t){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/",n(n.s=2)}([function(e,n){e.exports=t},function(t,e,n){window,t.exports=function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){"use strict";var i;function o(t,e,n){let i=n.value;if("function"!=typeof i)throw new TypeError("@autobind decorator can only be applied to methods not: "+typeof i);let o=!1;return{configurable:!0,get(){if(o||this===t.prototype||this.hasOwnProperty(e)||"function"!=typeof i)return i;const n=i.bind(this);return o=!0,Object.defineProperty(this,e,{configurable:!0,get:()=>n,set(t){i=t,delete this[e]}}),o=!1,n},set(t){i=t}}}n.r(e),function(t){t.CONNECTED="connected",t.MESSAGE="message",t.CONNECTING="connecting",t.DISCONNECTED="disconnected",t.ERROR="error",t.OPEN="open",t.INITIALIZED="initialized",t.CLOSED="closed",t.UNAVAILABLE="unavailable",t.CHANNEL_JOINED="channel_joined",t.CHANNEL_JOIN_FAILED="channel_join_failed",t.CHANNEL_LEFT="channel_left"}(i||(i={}));var s,r=function(t,e,n,i){var o,s=arguments.length,r=s<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,n,i);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,n,r):o(e,n))||r);return s>3&&r&&Object.defineProperty(e,n,r),r};!function(t){t.CLOSED="closed",t.JOINING="joining",t.JOINED="joined",t.LEAVING="leaving",t.ERROR="error"}(s||(s={}));class a{constructor(t,e){this.channelStatus=s.CLOSED,this.selfName=t,this.socket=e,this.cMgr=e.cMgr,this.enabled=!1}get status(){return this.channelStatus}get name(){return this.selfName}get isActive(){return this.cMgr.isConnected()&&this.channelStatus===s.JOINED}join(){this.enabled||(this.enabled=!0,this.startListening(),this.cMgr.isConnected()&&this.sendJoinCommand())}subscribe(t,e){this.cMgr.bind(t,e,this.name)}unsubscribe(t,e){this.cMgr.unbind(t,e,this.name)}leave(){this.enabled&&(this.enabled=!1,this.channelStatus=s.LEAVING,this.cMgr.isConnected()&&this.cMgr.sendLeave([this.name]),this.stopListening())}onConnect(){this.enabled&&this.sendJoinCommand()}onDisconnect(){this.channelStatus=s.CLOSED}onJoin(t){t.indexOf(this.name)>=0&&(this.channelStatus=s.JOINED)}onLeft(t){t.indexOf(this.name)>=0&&(this.channelStatus=s.CLOSED)}onJoinFailed(t){t.indexOf(this.name)>=0&&(this.channelStatus=s.ERROR)}sendJoinCommand(){this.channelStatus!==s.JOINING&&(this.channelStatus=s.JOINING,this.cMgr.sendJoin([this.name]))}startListening(){this.cMgr.bind(i.DISCONNECTED,this.onDisconnect),this.cMgr.bind(i.CHANNEL_JOIN_FAILED,this.onJoinFailed),this.cMgr.bind(i.CHANNEL_JOINED,this.onJoin),this.cMgr.bind(i.CHANNEL_LEFT,this.onLeft),this.cMgr.bind(i.CONNECTED,this.onConnect)}stopListening(){this.cMgr.unbind(i.DISCONNECTED,this.onDisconnect),this.cMgr.unbind(i.CHANNEL_JOIN_FAILED,this.onJoinFailed),this.cMgr.unbind(i.CHANNEL_JOINED,this.onJoin),this.cMgr.unbind(i.CHANNEL_LEFT,this.onLeft),this.cMgr.unbind(i.CONNECTED,this.onConnect)}}r([o],a.prototype,"onConnect",null),r([o],a.prototype,"onDisconnect",null),r([o],a.prototype,"onJoin",null),r([o],a.prototype,"onLeft",null),r([o],a.prototype,"onJoinFailed",null);const c={host:"",port:80,path:"",unavailableTimeout:1e4,retryTimeout:1e3,useTLS:!1};class l{constructor(){this.callbacks={}}get(t){return this.callbacks[t]||[]}add(t,e,n){this.callbacks[t]||(this.callbacks[t]=[]),this.callbacks[t].push({fn:e,channel:n||null})}remove(t,e,n){if(!t&&!e&&!n)return void(this.callbacks={});const i=t?[t]:Object.keys(this.callbacks);e||n?this.removeCallback(i,e,n):this.removeAllCallbacks(i)}removeCallback(t,e,n){t.forEach(t=>{const i=this.callbacks[t]||[];this.callbacks[t]=i.filter(t=>{const i=e&&e===t.fn,o=n&&n===t.channel;return!i&&!o})})}removeAllCallbacks(t){t.forEach(t=>{delete this.callbacks[t]})}}class h{constructor(){this.callbacks=new l}bind(t,e,n){return this.callbacks.add(t,e,n),this}unbind(t,e,n){return this.callbacks.remove(t,e,n),this}emit(t,e){const n=this.callbacks.get(t),i=(o=e)&&o.context&&"string"==typeof o.context.channel?e.context.channel:null;var o;return n&&n.length>0&&n.forEach(t=>{const n=t.channel===i;(!t.channel||!i||n)&&t.fn(e)}),this}}var d;!function(t){t.CHANNEL_JOINED="@join",t.CHANNEL_JOIN_FAILED="#join",t.CHANNEL_LEFT="@leave",t.CHANNEL_LEAVE_FAILED="#leave"}(d||(d={}));const u=new Set([d.CHANNEL_JOINED,d.CHANNEL_JOIN_FAILED,d.CHANNEL_LEFT,d.CHANNEL_LEAVE_FAILED]),p=t=>{const e={topic:t.type,payload:t.payload};return JSON.stringify(e)};var E;!function(t){t.JOIN="join",t.LEAVE="leave"}(E||(E={}));const f=new Set([E.JOIN,E.LEAVE]);class b extends h{constructor(t,e){super(),this.id=t,this.transport=e,this.bindListeners()}send(t){return!!this.transport&&this.transport.send(t)}sendCommand(t,e){if(f.has(t))throw new Error(t+" is a reserved command, cant be sent manually");return this.send(p({type:t,payload:e}))}sendJoin(t){this.send(p({type:E.JOIN,payload:t}))}sendLeave(t){this.send(p({type:E.LEAVE,payload:t}))}close(){this.transport&&this.transport.close()}bindListeners(){const t=t=>{this.transport&&(this.transport.unbind(i.MESSAGE,t.message),this.transport.unbind(i.ERROR,t.error),this.transport.unbind(i.CLOSED,t.closed))},e={message:t=>{let e=null;try{e=(t=>{if(t){const e=JSON.parse(t);if(u.has(e.topic)&&!e.payload&&Array.isArray(e.payload))return{type:y.ERROR,error:"WS event system event payload is invalid. Should be a string array",data:"MessageParseError"};switch(e.topic){case d.CHANNEL_JOINED:return{type:y.CHANNEL_JOINED,error:null,data:e.payload};case d.CHANNEL_JOIN_FAILED:return{type:y.CHANNEL_JOIN_FAILED,error:null,data:e.payload};case d.CHANNEL_LEFT:return{type:y.CHANNEL_LEFT,error:null,data:e.payload};case d.CHANNEL_LEAVE_FAILED:return{type:y.CHANNEL_LEAVE_FAILED,error:null,data:e.payload};default:return{type:y.MESSAGE,error:null,data:e.payload||null,context:{...e.topic?{channel:e.topic}:{}}}}}return{type:y.ERROR,error:"MessageEvent has no data property",data:"MessageParseError"}})(t.data)}catch(e){this.emit(i.ERROR,{type:y.ERROR,error:e,data:JSON.stringify(t)})}if(e)switch(e.type){case y.ERROR:this.emit(i.ERROR,e);break;case y.CHANNEL_JOIN_FAILED:this.emit(i.CHANNEL_JOIN_FAILED,e.data);break;case y.CHANNEL_JOINED:this.emit(i.CHANNEL_JOINED,e.data);break;case y.CHANNEL_LEFT:this.emit(i.CHANNEL_LEFT,e.data);break;case y.CHANNEL_LEAVE_FAILED:this.emit(i.ERROR,e);break;default:this.emit(i.MESSAGE,e)}},error:t=>{this.emit(i.ERROR,{...t,type:y.ERROR,data:null})},closed:n=>{var o;t(e),(o=n).context&&void 0!==o.context.code&&this.handleCloseEvent(n),this.transport=null,this.emit(i.CLOSED,n)}};this.transport&&(this.transport.bind(i.MESSAGE,e.message),this.transport.bind(i.ERROR,e.error),this.transport.bind(i.CLOSED,e.closed))}handleCloseEvent(t){const e=(t=>t.context&&t.context.code?t.context.code<4e3&&t.context.code>=1002&&t.context.code<=1004?{...t,error:"Socket is unavailable"}:t:(console.error("Socket event do not contain close code"),{...t,error:"Connection refused"}))(t);e.type===y.CLOSED?this.emit(i.CLOSED,e):this.emit(i.ERROR,e)}}class m extends h{constructor(t,e){super(),this.initialize=()=>{const t=this;t.hooks.isInitialized()?t.changeState(i.INITIALIZED):t.onClose()},this.hooks=t,this.name=e,this.state="new"}connect(){if(this.socket||"initialized"!==this.state)return!1;const{url:t}=this.hooks;try{this.socket=this.hooks.getSocket(t)}catch(t){return setTimeout(()=>{this.onError(t),this.onClosed({type:y.ERROR,data:t,error:t.toString(),context:{code:0}})}),!1}return this.bindListeners(),this.changeState(i.CONNECTING),!0}close(){return!!this.socket&&(this.socket.close(),!0)}send(t){return"open"===this.state&&(setTimeout(()=>{this.socket&&this.socket.send(t)}),!0)}unbindListeners(){this.socket&&(this.socket.onopen=null,this.socket.onerror=null,this.socket.onclose=null,this.socket.onmessage=null)}onOpen(){this.changeState(i.OPEN),this.socket&&(this.socket.onopen=null)}onError(t){var e;(e=t)&&"string"==typeof e.type&&void 0!==e.currentTarget?this.emit(i.ERROR,{type:y.ERROR,error:"Websocket connection error",data:null}):this.emit(i.ERROR,{type:y.ERROR,error:t?t.message:"Websocket connection error",data:t?t.name:null})}onClose(t){t?this.onClosed({type:t.wasClean?y.CLOSED:y.ERROR,data:t.wasClean?t.reason:null,error:t.wasClean?null:t.reason,context:{code:t.code}}):this.onClosed({type:y.ERROR,data:null,error:"Closed for unknown reason",context:{code:0}}),this.unbindListeners(),this.socket=void 0}onMessage(t){this.emit(i.MESSAGE,{type:y.MESSAGE,data:"string"==typeof t.data?t.data:JSON.stringify(t.data),error:null})}bindListeners(){this.socket&&(this.socket.onopen=()=>{this.onOpen()},this.socket.onerror=t=>{this.onError(t)},this.socket.onclose=t=>{this.onClose(t)},this.socket.onmessage=t=>{this.onMessage(t)})}changeState(t){this.state=t,this.emit(t,void 0)}onClosed(t){this.state=i.CLOSED,this.emit(i.CLOSED,t)}}class N{constructor(t,e){this.options=e||{};const n="ws"+(e.useTLS?"s":""),i=`${e.host}:${e.port}`,o=e.queryParams?Object.entries(e.queryParams).map(([t,e])=>`${encodeURIComponent(t)}=${encodeURIComponent(e)}`).join("&"):null,s=`${n}://${i}/${e.path}${o?"?"+o:""}`;this.hooks={url:s,isInitialized:()=>!!window.WebSocket,getSocket:t=>new WebSocket(t)},this.name=t}connect(t){let e=!1;const n=new m(this.hooks,this.name),o=()=>{n.unbind(i.INITIALIZED,o),n.connect()},s=()=>{n.unbind(i.INITIALIZED,o),n.unbind(i.OPEN,r),n.unbind(i.ERROR,a),n.unbind(i.CLOSED,c)},r=()=>{e=!0,s();const i=new b("",n);t(null,i)},a=()=>{},c=e=>{s(),t(e)};return n.bind(i.INITIALIZED,o),n.bind(i.OPEN,r),n.bind(i.ERROR,a),n.bind(i.CLOSED,c),n.initialize(),{abort:()=>{e||(s(),n.close())}}}}class C extends h{constructor(t){super(),this.options={...c,...t},this.state="initialized",this.connection=null,this.errorCallbacks=this.buildErrorCallbacks(),this.connectionCallbacks=this.buildConnectionCallbacks(this.errorCallbacks),this.transport=new N("ws",t),this.runner=null,this.unavailableTimer=0,this.retryTimer=0}connect(){this.connection||this.runner||(this.updateState(i.CONNECTING),this.startConnecting(),this.setUnavailableTimer())}send(t){return!!this.connection&&this.connection.send(t)}sendCommand(t,e){return!!this.connection&&this.connection.sendCommand(t,e)}sendJoin(t){return this.connection&&this.connection.sendJoin(t),!1}sendLeave(t){return this.connection&&this.connection.sendLeave(t),!1}disconnect(){this.disconnectInternally(),this.updateState(i.DISCONNECTED)}isConnected(){return this.state===i.CONNECTED}startConnecting(){this.runner=this.transport.connect((t,e)=>{t?(this.abandonConnection(),this.shouldRetry(t)&&this.retryIn(this.options.retryTimeout||0),this.emit(i.CLOSED,t)):(this.abortConnecting(),this.clearUnavailableTimer(),this.setConnection(e),this.updateState(i.CONNECTED))})}abortConnecting(){this.runner&&(this.runner.abort(),this.runner=null)}disconnectInternally(){if(this.abortConnecting(),this.clearRetryTimer(),this.clearUnavailableTimer(),this.connection){const t=this.abandonConnection();t&&t.close()}}retryIn(t){t>0&&this.emit(i.CONNECTING,{type:y.CONNECTING,data:String(Math.round(t/1e3)),error:null}),this.retryTimer=setTimeout(()=>{this.disconnectInternally(),this.connect()},t||0)}clearRetryTimer(){this.retryTimer&&(this.retryTimer&&clearTimeout(this.retryTimer),this.retryTimer=0)}setUnavailableTimer(){this.unavailableTimer=setTimeout(()=>{this.updateState(i.UNAVAILABLE)},this.options.unavailableTimeout)}clearUnavailableTimer(){this.unavailableTimer&&clearTimeout(this.unavailableTimer),this.unavailableTimer=0}buildConnectionCallbacks(t){return{...t,message:t=>{this.emit(i.MESSAGE,t)},error:t=>{this.emit(i.ERROR,t)},closed:t=>{this.abandonConnection(),this.shouldRetry(t)&&this.retryIn(this.options.retryTimeout||0),this.emit(i.CLOSED,t)},channelJoined:t=>this.emit(i.CHANNEL_JOINED,t),channelJoinFailed:t=>this.emit(i.CHANNEL_JOIN_FAILED,t),channelLeft:t=>this.emit(i.CHANNEL_LEFT,t)}}buildErrorCallbacks(){const t=t=>e=>{e.error&&this.emit(i.ERROR,{type:y.ERROR,data:null,error:e.error}),t(e)};return{refused:t(()=>{this.disconnect()}),unavailable:t(()=>{this.retryIn(1e3)})}}setConnection(t){this.connection=t,this.connection&&(this.connection.bind(i.MESSAGE,this.connectionCallbacks.message),this.connection.bind(i.CHANNEL_LEFT,this.connectionCallbacks.channelLeft),this.connection.bind(i.CHANNEL_JOIN_FAILED,this.connectionCallbacks.channelJoinFailed),this.connection.bind(i.CHANNEL_JOINED,this.connectionCallbacks.channelJoined),this.connection.bind(i.ERROR,this.connectionCallbacks.error),this.connection.bind(i.CLOSED,this.connectionCallbacks.closed))}abandonConnection(){if(!this.connection)return null;this.connection.unbind(i.MESSAGE,this.connectionCallbacks.message),this.connection.unbind(i.CHANNEL_LEFT,this.connectionCallbacks.channelLeft),this.connection.unbind(i.CHANNEL_JOIN_FAILED,this.connectionCallbacks.channelJoinFailed),this.connection.unbind(i.CHANNEL_JOINED,this.connectionCallbacks.channelJoined),this.connection.unbind(i.ERROR,this.connectionCallbacks.error),this.connection.unbind(i.CLOSED,this.connectionCallbacks.closed);const{connection:t}=this;return this.connection=null,t}updateState(t){const e=this.state;this.state=t,e!==t&&this.emit(t,void 0)}shouldRetry(t){return this.state===i.CONNECTING||this.state===i.CONNECTED}}var y;!function(t){t.CONNECTING="sfSocket:connecting",t.MESSAGE="sfSocket:message",t.CHANNEL_JOINED="channel_joined",t.CHANNEL_JOIN_FAILED="channel_join_failed",t.CHANNEL_LEFT="channel_left",t.CHANNEL_LEAVE_FAILED="channel_leave_failed",t.ERROR="sfSocket:error",t.CLOSED="sfSocket:closed"}(y||(y={}));class L{constructor(t){if(this.channels={},!t||"object"!=typeof t)throw new Error("sfSocket options should be an object");const e=t||{};this.config={...c,port:e.useTLS?443:80,...e},this.cMgr=new C(this.config),this.cMgr.bind(i.CONNECTED,()=>{Object.values(this.channels).forEach(t=>{t.join()})}),this.cMgr.bind(i.ERROR,t=>{console.error(t)}),L.instances.push(this),L.isReady&&this.connect()}static ready(){L.isReady=!0,L.instances.forEach(t=>{t.connect()})}connect(){this.cMgr.connect()}disconnect(){this.cMgr.disconnect()}sendCommand(t,e){return this.cMgr.sendCommand(t,e)}joinChannelList(t){t.forEach(t=>{this.joinChannel(t)})}leaveChannelList(t){t.forEach(t=>{this.leaveChannel(t)})}subscribe(t,e,n){return this.cMgr.bind(t,e,n)}unsubscribe(t,e,n){return this.cMgr.unbind(t,e,n)}joinChannel(t,e=!1){if(this.channels[t])throw new Error(`Channel ${t} already exists`);return this.channels[t]=new a(t,this),e||this.channels[t].join(),this.channels[t]}leaveChannel(t){if(!this.channels[t])throw new Error(`Channel ${t} does not exist`);const e=this.channels[t];return e.leave(),delete this.channels[t],e}getChannel(t){return this.channels[t]}}L.instances=[],L.isReady=!1,n.d(e,"makeSocketOptions",(function(){return O})),n.d(e,"SFSocket",(function(){return L})),n.d(e,"eventNames",(function(){return i}));const O=t=>{const e=new URL(t),n=e.protocol?e.protocol.replace(":",""):null;return e.hostname&&e.port&&n?{host:e.hostname,port:e.port,path:n}:null};e.default=L}])},function(t,e,n){t.exports=n(3)},function(t,e,n){"use strict";n.r(e),n.d(e,"version",(function(){return u}));var i,o=n(0),s=n.n(o),r=n(1),a=(i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),c=function(){return(c=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},l=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var i,o,s=n.call(t),r=[];try{for(;(void 0===e||e-- >0)&&!(i=s.next()).done;)r.push(i.value)}catch(t){o={error:t}}finally{try{i&&!i.done&&(n=s.return)&&n.call(s)}finally{if(o)throw o.error}}return r},h=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(l(arguments[e]));return t};var d=function(t){function e(n,i,o){var r=t.call(this)||this;return r.options=c({},e.defaultOptions),r.name=e.spiralFrameworkName,r.optionsToGrab={},r.data=[],r.unreadCount=0,r.selected=new Set,r.init(n,i,o),r.options=c(c({},e.defaultOptions),r.options),r.toastTemplate=s.a.helpers.template.compile('<div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">\n    <div class="toast-header">\n         <div class="custom-control custom-checkbox mr-auto">\n          <input type="checkbox" class="custom-control-input" id="sf-notification-{{id}}" {{#if selected}}checked="checked"{{/if}}>\n          <label class="custom-control-label" for="sf-notification-{{id}}">{{{title}}}</label>\n        </div>\n        <small>{{date}}</small>\n        <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">\n            <span aria-hidden="true">&times;</span>\n        </button>\n    </div>\n    <div class="toast-body">\n        {{{body}}}\n    </div>\n</div>'),r.ui={drawer:{body:document.querySelector(r.options.drawer.body),container:document.querySelector(r.options.drawer.container),counter:document.querySelector(r.options.drawer.counter),mask:document.querySelector(r.options.drawer.mask),btn:document.querySelector(r.options.drawer.btn)},header:{counter:document.querySelector(r.options.header.counter),toggle:document.querySelector(r.options.header.toggle)}},r.initWs(),r.bindEvents(),r.reload(),r}return a(e,t),e.prototype.toggleDrawer=function(){this.ui.drawer.container.classList.toggle("drawer-open")},e.prototype.bindEvents=function(){this.toggleDrawer=this.toggleDrawer.bind(this),this.markSelection=this.markSelection.bind(this),this.ui.header.toggle.addEventListener("click",this.toggleDrawer),this.ui.drawer.mask.addEventListener("click",this.toggleDrawer),this.ui.drawer.btn.addEventListener("click",this.markSelection)},e.prototype.unbindEvents=function(){this.ui.header.toggle.removeEventListener("click",this.toggleDrawer)},e.prototype.calcSelected=function(){var t=this;h(this.selected.values()).forEach((function(e){t.data.find((function(t){return t.id===e}))||t.selected.delete(e)}))},e.prototype.updateButton=function(){var t="Mark All As Read";this.selected.size&&this.selected.size<this.data.length&&(t="Mark "+this.selected.size+" As Read"),this.ui.drawer.btn.innerHTML=t},e.prototype.initWs=function(){var t=this;this.options.ws&&(this.ws=new r.SFSocket(this.options.ws),this.ws.subscribe("message",(function(e){try{var n=JSON.parse(e.data||"");if(function(t){return!("notification"!==t.type||!t.data)&&!!(t.data.title&&t.data.id&&t.data.body)}(n)){var i=n.data;t.onNotification(i)}}catch(t){}})))},e.prototype.onNotification=function(t){var e=this.data.findIndex((function(e){return e.id===t.id}));t.icon&&(t.title='<i class="fas fa-'+t.icon+'"></i>&nbsp;'+t.title),e>=0?this.data[e]=t:this.data=h([t],this.data).sort((function(t){return t.date||0})),this.unreadCount=this.data.filter((function(t){return!t.read})).length,this.calcSelected();var n=new CustomEvent("sf:notification-show",{bubbles:!0,detail:{message:"<div>"+t.title+'&nbsp;&nbsp;<small class="float-right">'+this.date(t.date)+'</small><hr class="mx-0 my-1"/>'+t.body+"</div>",type:"primary",position:"tr",timeout:2e3,onClick:this.toggleDrawer}});document.dispatchEvent(n),this.render()},e.prototype.reload=function(){var t=this;s.a.ajax.send({method:"GET",url:this.options.api.getList}).then((function(e){var n=e.data;t.handleResponse(n)}))},e.prototype.handleResponse=function(t){this.unreadCount=t.unreadCount||this.unreadCount,this.data=t.data||this.data,this.calcSelected(),this.render()},e.prototype.date=function(t){return t?s.a.helpers.luxon.DateTime.fromJSDate(new Date(t)).toFormat("HH:mm yyyy-MM-dd"):""},e.prototype.renderNotitifation=function(t){var e=this.date(t.date),n=this.toastTemplate(c(c({},t),{date:e})),i=document.createElement("div");i.innerHTML=n;var o=i.firstChild;return this.bindToast(o,t),t.read&&o.classList.add("d-none"),o},e.prototype.render=function(){var t=this;this.ui.header.counter.innerText=this.unreadCount.toString(),this.ui.header.counter.classList.toggle("d-none",!this.unreadCount),this.ui.drawer.counter.innerText=this.unreadCount.toString(),this.ui.drawer.counter.classList.toggle("d-none",!this.unreadCount),this.ui.drawer.body.innerHTML="",this.data.forEach((function(e){var n=t.renderNotitifation(c(c({},e),{selected:t.selected.has(e.id)}));t.ui.drawer.body.appendChild(n)})),this.updateButton()},e.prototype.bindToast=function(t,e){var n=this;t.querySelector("[data-dismiss]").addEventListener("click",(function(){n.markAsRead(e,t)}));var i=t.querySelector("input");i.addEventListener("change",(function(){i.checked?n.selected.add(e.id):n.selected.delete(e.id),n.updateButton()}))},e.prototype.die=function(){this.unbindEvents()},e.prototype.markAsRead=function(t,e){var n=this;t.read=!0,e.classList.toggle("show"),this.unreadCount=this.data.filter((function(t){return!t.read})).length,s.a.ajax.send({method:"POST",data:{id:t.id},url:this.options.api.setAsRead}).then((function(t){var e=t.data;n.handleResponse(e)})).catch((function(){n.reload()}))},e.prototype.markSelection=function(){var t=this,e=this.data.map((function(t){return t.id}));this.selected.size&&this.selected.size<e.length&&(e=h(this.selected.values())),s.a.ajax.send({method:"POST",data:{id:e},url:this.options.api.setAsRead}).then((function(e){var n=e.data;t.handleResponse(n)})).catch((function(){t.reload()}))},e.spiralFrameworkName="notifications",e.spiralFrameworkCssName="js-sf-notifications-dyn",e.defaultOptions={drawer:{container:".js-sf-notifications",body:".js-sf-notifications-body",counter:".js-sf-notifications-count",mask:".js-sf-notifications-mask",btn:".js-sf-notifications-button"},header:{toggle:".js-sf-notifications-toggle",counter:".js-sf-notifications-counter"},api:{getList:"/api/notifications",setAsRead:"/api/notifications/read"},ws:!1},e}(s.a.core.BaseDOMConstructor);s.a.registerInstanceType(d,d.spiralFrameworkCssName);var u="Version 1.1.56, built at Mon Oct 26 2020 11:33:52 GMT+0300 (Moscow Standard Time)";e.default=d}])}));
//# sourceMappingURL=notifications.js.map